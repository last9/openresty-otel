services:
  openresty:
    build: .
    container_name: openresty
    ports:
      - "80:80"
      - "9145:9145"   # Prometheus metrics + nginx_status
    environment:
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-openresty}
      - OTEL_SERVICE_VERSION=${OTEL_SERVICE_VERSION:-1.0.0}
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - DEPLOYMENT_ENVIRONMENT=${DEPLOYMENT_ENVIRONMENT:-production}
      - OTEL_TRACES_SAMPLER=${OTEL_TRACES_SAMPLER:-parentbased_always_on}
      - OTEL_TRACES_SAMPLER_ARG=${OTEL_TRACES_SAMPLER_ARG:-1.0}
      - OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT=${OTEL_ATTRIBUTE_VALUE_LENGTH_LIMIT:-256}
    volumes:
      - nginx_logs:/var/log/nginx
    depends_on:
      - otel-collector
    networks:
      - monitoring

  # Example upstream â€” replace with your own service
  httpbin:
    image: ghcr.io/mccutchen/go-httpbin:latest
    container_name: httpbin
    networks:
      - monitoring

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.144.0
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    environment:
      - LAST9_OTLP_ENDPOINT=${LAST9_OTLP_ENDPOINT}
      - LAST9_OTLP_AUTH=${LAST9_OTLP_AUTH}
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
      - nginx_logs:/var/log/nginx:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - monitoring

volumes:
  nginx_logs:

networks:
  monitoring:
    name: monitoring
